# K3s deployment example for HyperCloud

This example will help you deploy a basic Kubernetes cluster into HyperCloud,
and additionally an application running on top integrated with S3 storage from
HyperCloud, and configured with SSL certificates.

To run these scripts you will need `terraform` and `ansible` tools
installed.

Some variables used by the scripts need to be modified to work on other
environments as there are a few values hardcoded. You can find them in
[terraform/terraform.tfvars]:

- `hypercloud_image_id` - ID of the image to use on the VMs, Debian or Ubuntu.
- `hypercloud_group` - Name of the group used to deploy the VMs.
- `internal_net_id` - ID of the network used by the VMs. Needs to be reachable
  from where you are running the deployment scripts.
- `public_net_id` - ID of a network that can get public IPs.
- `public_net_ip` - The public IP to use.

## Creating the VMs with Terraform

First you have to run the Terraform scripts from the `terraform/` folder. You
will need a couple of env variables with your HyperCloud credentials to
authenticate, for example:

    export TF_VAR_one_username="palvarez"
    export TF_VAR_one_password="23a0ce0ac7809e0as98e7..."

With those env variables configured, you should be able to run the Terraform
scripts:

    terraform init
    terraform apply

This will create all the VMs needed, and an Ansible inventory file located on
`ansible/inventory/hosts`


## Installing K3s

With the VMs deployed, you can run the following Ansible playbook from
the `ansible/` folder:

    ansible-playbook -i inventory/hosts k3s_cluster.yaml

This command will take a while. It will configure all the Kubernetes nodes.

## Example applications on Kubernetes

Once Kubernetes is running, you can start installing things on top. You can
find on the `kubernetes/` folder the examples we are going to be deploying now.

### Haste-Server with S3 integration

This example will deploy a pastebin service that will use HyperCloud S3 as the
storage backend.

The main file we are going to be deploying is [kubernetes/haste-server/haste-server.yaml],
which will be deploying an instance of [haste-server], configured to store
all data on HyperCloud object storage.

In the file mentioned above, you will need to modify the following env
variables to match your environment:

- `STORAGE_AWS_ENDPOINT`
- `STORAGE_AWS_BUCKET`
- `STORAGE_AWS_KEY_ID`
- `STORAGE_AWS_KEY_SECRET`

The Ingress to this service is configured with SSL certificates automatically
generated by Let's Encrypt. For this to work, we will need to install
`cert-manager` first into the Kubernetes cluster.

To simplify all this, you can run the following Ansible script which will deploy
everything. Again, from the `ansible/` folder.

    ansible-playbook -i inventory/hosts deploy_haste_kubernetes.yaml

[terraform/terraform.tfvars]: terraform/terraform.tfvars
[kubernetes/haste-server/haste-server.yaml]: kubernetes/haste-server/haste-server.yaml
[haste-server]: https://github.com/toptal/haste-server
